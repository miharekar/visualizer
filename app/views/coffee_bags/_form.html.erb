<div class="md:col-span-2" id="<%= dom_id(@coffee_bag) %>">
  <%= form_with(model: @coffee_bag, data: { controller: "coffee-bag-scraper canonical-selector" }) do |f| %>
    <div class="sm:overflow-hidden sm:rounded-md md:shadow">
      <div class="flex flex-col gap-y-6 py-5 px-4 bg-white sm:p-6 dark:bg-neutral-800">
        <div class="grid grid-cols-6 gap-6">
          <div class="col-span-6">
            <%= f.label :url, "Web page with information", class: "standard-label" %>
            <div class="flex-1 mt-3 text-sm text-neutral-600 dark:text-neutral-400">
              <div class="flex flex-row gap-2 items-center">
                <%= f.text_field :url, class: "mt-0 standard-input", data: {coffee_bag_scraper_target: "url", scrape_url: scrape_info_coffee_bags_path,action: "change->coffee-bag-scraper#fetch"} %>
                <button type="button" class="py-2 px-4 whitespace-nowrap button-terracotta" data-action="coffee-bag-scraper#fetch">
                  Get info
                </button>
                <div data-coffee-bag-scraper-target="loader" class="hidden col-span-6 mx-auto">
                  <%= inline_svg_tag "logo-loading.svg", class: "logo-loading size-10 stroke-neutral-800 text-neutral-800 dark:text-neutral-300 dark:stroke-neutral-300" %>
                </div>
              </div>
            </div>
          </div>
          <div class="col-span-6 sm:col-span-4">
            <% name_errors = f.object.errors.select { |e| e.attribute == :name } %>
            <% if name_errors.any? %>
              <% name_extra_classes = "ring-1 ring-red-500 border-red-500" %>
            <% end %>
            <%= f.label :name, class: "standard-label" %>
            <div class="relative">
              <% if @coffee_bag&.roaster&.canonical_roaster_id %>
                <!--TODO: auto update roaster-->
                <div class="relative" data-controller="autocomplete" data-canonical-selector-target="autocomplete" data-autocomplete-url-value="<%= autocomplete_coffee_bags_canonical_index_path(roaster_id: @coffee_bag.roaster.canonical_roaster_id) %>" data-autocomplete-min-length-value="3" data-autocomplete-selected-class="text-white bg-oxford-blue-400 dark:bg-oxford-blue-700">
                  <%= f.hidden_field :canonical_coffee_bag_id, data: { autocomplete_target: "hidden", canonical_selector_target: "id", coffee_bag_scraper_target: "canonicalId" } %>
                  <%= f.search_field :name, class: "#{name_extra_classes} ps-10 mt-1 standard-input", data: { autocomplete_target: "input", canonical_selector_target: "input" } %>
                  <ul class="overflow-y-auto absolute z-10 mt-2 max-h-96 bg-white rounded-md ring-1 shadow-lg list-group ring-black/5" data-autocomplete-target="results"></ul>
                  <div class="<%= "hidden" unless coffee_bag.canonical_coffee_bag_id %> pointer-events-none absolute inset-y-0 left-2 flex items-center" data-canonical-selector-target="verified">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75m-3-7.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285Z" />
                    </svg>
                  </div>
                </div>
              <% else %>
                <%= f.text_field :name, class: "#{name_extra_classes} mt-1 standard-input" %>
              <% end %>
            </div>
            <% if name_errors.any? %>
              <p class="text-sm font-medium text-red-500">
                <% if name_errors.any? { |e| e.type == :blank } %>
                  Name is required.
                <% elsif name_errors.any? { |e| e.type == :taken } %>
                  Coffee bag with this name and roast date already exists on this roaster.
                <% else %>
                  <%= name_errors.map(&:full_message).join(", ") %>
                <% end %>
              </p>
            <% end %>
          </div>
          <div class="col-span-6 sm:col-span-3">
            <% roaster_errors = f.object.errors.select { |e| e.attribute == :roaster } %>
            <% if roaster_errors.any? %>
              <% roaster_extra_classes = "ring-1 ring-red-500 border-red-500" %>
            <% end %>
            <div class="flex justify-between">
              <%= f.label :roaster, class: "standard-label" %>
              <div class="text-sm text-neutral-500 dark:text-neutral-400">
                <%= link_to "Manage", roasters_path, class: "standard-link", data: { turbo_frame: "_top" } %>
                |
                <%= link_to "New", new_roaster_path, class: "standard-link", data: { turbo_frame: "_top" } %>
              </div>
            </div>
            <%= render partial: "shared/combobox", locals: { input_name: :roaster, hidden_input_name: "coffee_bag[roaster_id]", selected: @coffee_bag.roaster, collection: @roasters, extra_text_field_classes: roaster_extra_classes} %>
            <% if roaster_errors.any? %>
              <p class="text-sm font-medium text-red-500">
                <% if roaster_errors.any? { |e| e.type == :blank } %>
                  Roaster is required.
                <% else %>
                  <%= roaster_errors.map(&:full_message).join(", ") %>
                <% end %>
              </p>
            <% end %>
          </div>
          <div class="col-span-6 sm:col-span-3">
            <%= f.label :roast_date, class: "standard-label" %>
            <%= f.date_field :roast_date, class: "mt-1 standard-input" %>
          </div>
          <div class="col-span-6 sm:col-span-3">
            <%= f.label :roast_level, class: "standard-label" %>
            <%= f.text_field :roast_level, class: "mt-1 standard-input" %>
          </div>
          <div class="col-span-6 sm:col-span-3">
            <%= f.label :country, class: "standard-label" %>
            <%= f.text_field :country, class: "mt-1 standard-input" %>
          </div>
          <div class="col-span-6 sm:col-span-3">
            <%= f.label :region, class: "standard-label" %>
            <%= f.text_field :region, class: "mt-1 standard-input" %>
          </div>
          <div class="col-span-6 sm:col-span-3">
            <%= f.label :farm, class: "standard-label" %>
            <%= f.text_field :farm, class: "mt-1 standard-input" %>
          </div>
          <div class="col-span-6 sm:col-span-3">
            <%= f.label :farmer, class: "standard-label" %>
            <%= f.text_field :farmer, class: "mt-1 standard-input" %>
          </div>
          <div class="col-span-6 sm:col-span-3">
            <%= f.label :variety, class: "standard-label" %>
            <%= f.text_field :variety, class: "mt-1 standard-input" %>
          </div>
          <div class="col-span-6 sm:col-span-3">
            <%= f.label :elevation, class: "standard-label" %>
            <%= f.text_field :elevation, class: "mt-1 standard-input" %>
          </div>
          <div class="col-span-6 sm:col-span-3">
            <%= f.label :processing, class: "standard-label" %>
            <%= f.text_field :processing, class: "mt-1 standard-input" %>
          </div>
          <div class="col-span-6 sm:col-span-3">
            <%= f.label :harvest_time, class: "standard-label" %>
            <%= f.text_field :harvest_time, class: "mt-1 standard-input" %>
          </div>
          <div class="col-span-6 sm:col-span-3">
            <%= f.label :quality_score, class: "standard-label" %>
            <%= f.text_field :quality_score, class: "mt-1 standard-input" %>
          </div>
          <div class="col-span-6">
            <%= f.label :tasting_notes, class: "standard-label" %>
            <%= f.text_field :tasting_notes, class: "mt-1 standard-input" %>
          </div>
          <div class="col-span-6">
            <%= f.label :place_of_purchase, class: "standard-label" %>
            <%= f.text_field :place_of_purchase, class: "mt-1 standard-input" %>
          </div>
        </div>
        <div>
          <%= f.label :notes, class: "standard-label" %>
          <div class="mt-1">
            <%= f.text_area :notes, rows: 10, class: "shadow-sm font-mono focus:ring-oxford-blue-500 focus:border-oxford-blue-500 mt-1 block w-full sm:text-sm border-neutral-300 rounded-md dark:bg-neutral-800" %>
            <div class="mt-2 text-sm text-neutral-500 dark:text-neutral-400">
              Supports
              <a class="standard-link" target="_blank" href="https://guides.github.com/features/mastering-markdown/">GitHub Flavored Markdown</a>.
            </div>
          </div>
        </div>
        <div>
          <div data-controller="image-form">
            <%= f.label :image, "Image", class: "standard-label" %>
            <% if @coffee_bag.image.attached? && @coffee_bag.image.persisted? && @coffee_bag.image.variable? %>
              <div id="coffee-bag-image">
                <%= image_tag @coffee_bag.image.variant(:thumb), class: "rounded-lg mt-1" %>
                <div class="flex mt-1 mb-4 text-sm text-red-600 dark:text-red-700 hover:text-red-800 dark:hover:text-red-600">
                  <svg class="size-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                  <%= link_to "Remove Image", remove_image_coffee_bag_path(@coffee_bag), data: { turbo_method: :delete }, class: "standard-link text-sm" %>
                </div>
              </div>
            <% end %>
            <div class="mt-1">
              <%= f.file_field :image, class: "standard-file-input" %>
            </div>
          </div>
        </div>
      </div>
      <div class="py-3 px-4 text-right sm:px-6 bg-neutral-50 dark:bg-neutral-700">
        <%= f.submit "Save", class: "button-terracotta py-2 px-4" %>
      </div>
    </div>
  <% end %>
</div>
<div id="scraper-error-template" class="hidden">
  <%= render Notification.new(type: :alert, heading: "Error fetching coffee info", text: "Something went wrong", timeout: 3000) %>
</div>
