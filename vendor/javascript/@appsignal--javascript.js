// @appsignal/javascript@1.6.1 downloaded from https://ga.jspm.io/npm:@appsignal/javascript@1.6.1/dist/esm/index.js

import{__awaiter as t,__generator as r,__extends as e,__assign as n,__values as o,__spreadArray as i,__read as a}from"tslib";function s(t){return typeof t==="object"&&typeof t.message!=="undefined"}function u(t){if(typeof t.stacktrace!=="undefined"||typeof t["opera#sourceloc"]!=="undefined"){var r=t.stacktrace,e=r===void 0?"":r;return e.split("\n").filter((function(t){return t!==""}))}if(t.stack){var n=t.stack,o=n===void 0?"":n;return o.split("\n").filter((function(t){return t!==""}))}return["No stacktrace available"]}function c(t){if(t){var r={};Object.keys(t).forEach((function(e){typeof t[e]==="object"?r[e]=JSON.stringify(t[e]):r[e]=String(t[e])}));return r}}function h(t){if(t){var r={};Object.keys(t).forEach((function(e){typeof t[e]==="string"||typeof t[e]==="boolean"||typeof t[e]==="number"?r[e]=t[e]:r[e]=JSON.stringify(t[e])}));return r}}var p="1.6.0";var f=function(){function t(){}t.serialize=function(){return{transport:this.transport(),origin:this.origin()}};t.origin=function(){var t=l();return t.location?t.location.origin||"".concat(t.location.protocol,"//").concat(t.location.hostname):""};t.transport=function(){var t=l();return d()&&typeof jest==="undefined"?"NodeHTTP":t.XDomainRequest?"XDomainRequest":t.XMLHttpRequest&&!t.fetch?"XMLHttpRequest":"fetch"};t.supportsPromises=function(){var t=l();return"Promise"in t&&"resolve"in t.Promise&&"reject"in t.Promise&&"all"in t.Promise&&"race"in t.Promise&&function(){var r;new t.Promise((function(t){r=t}));return typeof r==="function"}()};return t}();function d(){return Object.prototype.toString.call(typeof process!=="undefined"?process:0)==="[object process]"}function l(){return d()?global:typeof window!=="undefined"?window:typeof self!=="undefined"?self:{}}var v=function(){function t(t){this.url=t}t.prototype.send=function(t){var r=this;return new Promise((function(e,n){var o;var i=new XDomainRequest;var a=new RegExp("^https?:");i.onload=function(){return e({})};i.open("POST",r.url.replace(a,(o=window===null||window===void 0?void 0:window.location)===null||o===void 0?void 0:o.protocol));setTimeout((function(){try{i.send(t)}catch(t){n(t)}}),0)}))};return t}();var m=function(){function t(t){this.url=t}t.prototype.send=function(t){var r=this;return new Promise((function(e,n){try{var o=new XMLHttpRequest;o.onreadystatechange=function(){o.readyState===XMLHttpRequest.DONE&&e({})};o.open("POST",r.url);o.send(t)}catch(t){n(t)}}))};return t}();var y=function(){function e(t,r){this.url=t}e.prototype.send=function(e){return t(this,void 0,void 0,(function(){var t,n,o;return r(this,(function(r){switch(r.label){case 0:return[4,fetch(this.url,{method:"POST",body:e})];case 1:t=r.sent();n=t.statusText,o=t.ok;return[2,o?Promise.resolve({}):Promise.reject({statusText:n})]}}))}))};return e}();var _=function(){function t(t){this.url=t;this.https=import("https")}t.prototype.send=function(t){var r=this;var e={method:"POST",headers:{"Content-Type":"application/json","Content-Length":t.length}};return new Promise((function(n,o){r.https.then((function(i){var a=i.request(r.url,e,(function(){})).on("error",(function(t){return o(t)}));a.write(t);a.end();n({})})).catch((function(t){console.warn("NodeTransport is being used, but the HTTPS module could not be imported. No data will be sent to AppSignal.");o(t)}))}))};return t}();var g=function(){function e(t){this._uri=t.uri||"https://appsignal-endpoint.net/collect";this._apiKey=t.key;this._clientVersion=t.version;this._transport=this._createTransport(this._url())}e.prototype.push=function(e){return t(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this._transport.send(e.toJSON())];case 1:t.sent();return[2,e]}}))}))};e.prototype._createTransport=function(t){switch(f.transport()){case"XDomainRequest":return new v(t);case"XMLHttpRequest":return new m(t);case"NodeHTTP":return new _(t);default:return new y(t)}};e.prototype._url=function(){var t=this._authorization();return"".concat(this._uri,"?").concat(b(t))};e.prototype._authorization=function(){return{api_key:this._apiKey,version:this._clientVersion}};return e}();function b(t){return Object.keys(t).map((function(r){return"".concat(encodeURIComponent(r),"=").concat(encodeURIComponent(t[r]))})).join("&")}var w=function(){function t(t){this._data=t}t.prototype.toJSON=function(){return JSON.stringify(this._data)};t.prototype.serialize=function(){return this._data};return t}();var P=function(t){e(r,t);function r(r){return t.call(this,n({timestamp:Math.round((new Date).getTime()/1e3),namespace:"frontend",error:{name:"NullError",message:"No error has been set",backtrace:[]}},r))||this}r.prototype.setAction=function(t){if(!t||typeof t!=="string")return this;this._data.action=t;return this};r.prototype.getAction=function(){return this._data.action};r.prototype.setNamespace=function(t){if(!t||typeof t!=="string")return this;this._data.namespace=t;return this};r.prototype.getNamespace=function(){return this._data.namespace};r.prototype.setError=function(t){if(!t||!s(t))return this;this._data.error={name:t.name||"[unknown]",message:t.message,backtrace:u(t)};return this};r.prototype.getError=function(){return this._data.error};r.prototype.setTags=function(t){this._data.tags=n(n({},this._data.tags),c(t));return this};r.prototype.getTags=function(){var t;return(t=this._data.tags)!==null&&t!==void 0?t:{}};r.prototype.setParams=function(t){this._data.params=n(n({},this._data.params),t);return this};r.prototype.getParams=function(){var t;return(t=this._data.params)!==null&&t!==void 0?t:{}};r.prototype.setBreadcrumbs=function(t){this._data.breadcrumbs=t;return this};r.prototype.getBreadcrumbs=function(){var t;return(t=this._data.breadcrumbs)!==null&&t!==void 0?t:[]};r.prototype.setEnvironment=function(t){this._data.environment=n(n({},this._data.environment),t);return this};r.prototype.getEnvironment=function(){var t;return(t=this._data.environment)!==null&&t!==void 0?t:{}};r.prototype.cleanBacktracePath=function(t){if(t.length===0)return this;if(!this._data.error||!this._data.error.backtrace)return this;var r=0;this._data.error.backtrace=this._data.error.backtrace.map((function(e){var n,i;var a=A(e);if(!a)return e;try{for(var s=o(t),u=s.next();!u.done;u=s.next()){var c=u.value;var h=c(a);if(h){r++;return e.replace(a,h)}}}catch(t){n={error:t}}finally{try{u&&!u.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}return e}));r>0&&this.setEnvironment({backtrace_paths_matched:r.toString()});return this};return r}(w);function E(t){return function(r){var e=r.match(t);if(e&&!(e.length<2))return e.slice(1).join("")}}function A(t){var r,e,n,o;var i=/^\s*at\s/;var a=/^\s*at(?:\s[^\(]+)?\s\((.*):\d+:\d+\)$/;var s=/^\s*at\s(.*):\d+:\d+$/;if(t.match(i))return(e=(r=t.match(a))===null||r===void 0?void 0:r[1])!==null&&e!==void 0?e:(n=t.match(s))===null||n===void 0?void 0:n[1];var u=/^.*@/;var c=/^.*@\s?(.*):\d+:\d+$/;return t.match(u)?(o=t.match(c))===null||o===void 0?void 0:o[1]:void 0}var k=function(){function t(t){this._data=t||[]}t.prototype.clear=function(){this._data=[]};t.prototype.values=function(){return this._data};t.prototype.push=function(t){var r;return Array.isArray(t)?(r=this._data).push.apply(r,i([],a(t),false)):this._data.push(t)};t.prototype.drain=function(){return r(this,(function(t){switch(t.label){case 0:return this._data.length>0?[4,this._data.shift()]:[3,2];case 1:t.sent();return[3,0];case 2:return[2]}}))};return t}();var S=function(){function e(t,r,e){this._retries=0;this._timerID=0;this._duration=0;this._api=r;this._queue=t;this.options=n({limit:5,initialDuration:1e3},e);this.reset()}e.prototype.schedule=function(e){var n=this;e===void 0&&(e=this._duration);var i=l();var a=1.3;var s=function(){return t(n,void 0,void 0,(function(){var t,n,i,s,u;var c,h;return r(this,(function(r){switch(r.label){case 0:r.trys.push([0,7,8,9]);t=o(this._queue.drain()),n=t.next();r.label=1;case 1:if(!!n.done)return[3,6];i=n.value;if(!i)return[2];r.label=2;case 2:r.trys.push([2,4,,5]);return[4,this._api.push(i)];case 3:r.sent();return[3,5];case 4:r.sent();s=Math.floor(Math.pow(e,a));this._retries=this._retries-1;if(this._retries===0)this.reset();else{this._queue.push(i);this._timerID=this.schedule(s)}return[2];case 5:n=t.next();return[3,1];case 6:return[3,9];case 7:u=r.sent();c={error:u};return[3,9];case 8:try{n&&!n.done&&(h=t.return)&&h.call(t)}finally{if(c)throw c.error}return[7];case 9:this.reset();return[2]}}))}))};return i.setTimeout(s,e)};e.prototype.reset=function(){var t=this.options,r=t.limit,e=t.initialDuration;this._retries=r;this._duration=e};return e}();var N=function(){function e(t){var r,e;this.VERSION=p;this.ignored=[];this.backtraceMatchers=[];this._breadcrumbs=[];this._hooks={decorators:Array(),overrides:Array()};this._env=f.serialize();this._queue=new k([]);var n=t.key,i=n===void 0?"":n,a=t.uri,s=t.revision,u=t.ignoreErrors,c=t.matchBacktracePaths;s&&typeof s!=="string"&&(t.revision=String(s));i===""&&console.info("[APPSIGNAL]: No API key provided. Started in development mode. No data will be sent.");this._api=new g({key:i,uri:a,version:this.VERSION});u&&Array.isArray(u)&&(this.ignored=u.filter((function(t){return t instanceof RegExp})).map(T));if(c){var h=void 0;h=Array.isArray(c)?c:[c];try{for(var d=o(h),l=d.next();!l.done;l=d.next()){var v=l.value;v instanceof RegExp?this.backtraceMatchers.push(E(T(v))):typeof v==="function"&&this.backtraceMatchers.push(v)}}catch(t){r={error:t}}finally{try{l&&!l.done&&(e=d.return)&&e.call(d)}finally{if(r)throw r.error}}}this._dispatcher=new S(this._queue,this._api);this._options=t}e.prototype.send=function(t,r,e){var n,i,a,s;var u=this;var c;if(t instanceof Error||t instanceof P||t&&t.error instanceof Error){var p;p="error"in t?t.error:t;var d=p instanceof P?p:this._createSpanFromError(p);try{for(var l=o(this._hooks.decorators),v=l.next();!v.done;v=l.next()){var m=v.value;var y=d;d=m(d);d===void 0&&(d=y)}}catch(t){n={error:t}}finally{try{v&&!v.done&&(i=l.return)&&i.call(l)}finally{if(n)throw n.error}}if(r)if(typeof r==="function"){var _=r;_(d)}else{console.warn("[APPSIGNAL]: DEPRECATED: Calling the `send`/`sendError` function with a tags object is deprecated. Use the callback argument instead.");var g=h(r)||{};d.setTags(g)}if(e){console.warn("[APPSIGNAL]: DEPRECATED: Calling the `send`/`sendError` function with a namespace is deprecated. Use the callback argument instead.");d.setNamespace(e)}this._breadcrumbs.length>0&&d.setBreadcrumbs(this._breadcrumbs);try{for(var b=o(this._hooks.overrides),w=b.next();!w.done;w=b.next()){var E=w.value;y=d;var A=E(d);if(A===false){console.warn("[APPSIGNAL]: Ignored a span due to override.");return}d=A!==null&&A!==void 0?A:y}}catch(t){a={error:t}}finally{try{w&&!w.done&&(s=b.return)&&s.call(b)}finally{if(a)throw a.error}}var k=(c=d.getError())===null||c===void 0?void 0:c.message;if(k&&this.ignored.some((function(t){return t.test(k)})))console.warn("[APPSIGNAL]: Ignored a span: ".concat(k));else{d.cleanBacktracePath(this.backtraceMatchers);if(f.supportsPromises()){this._breadcrumbs=[];if(this._options.key)return this._api.push(d).catch((function(){u._queue.push(d);setTimeout((function(){return u._dispatcher.schedule()}),0)}));console.warn("[APPSIGNAL]: Span not sent because we're in development mode:",d)}else console.error("[APPSIGNAL]: Error not sent. A Promise polyfill is required.")}}else console.error("[APPSIGNAL]: Can't send error, given error is not a valid type")};e.prototype.sendError=function(t,r,e){return this.send(t,r,e)};e.prototype.use=function(t){t.call(this)};e.prototype.createSpan=function(t){var r=this._options,e=r.revision,n=e===void 0?"":e,o=r.namespace;var i=new P({environment:this._env,revision:n});o&&i.setNamespace(o);t&&typeof t==="function"&&t(i);return i};e.prototype.wrap=function(e,n,o){return t(this,void 0,void 0,(function(){var t;return r(this,(function(r){switch(r.label){case 0:r.trys.push([0,2,,5]);return[4,e()];case 1:return[2,r.sent()];case 2:t=r.sent();return t instanceof Error||t instanceof ErrorEvent?[4,this.sendError(t,n,o)]:[3,4];case 3:r.sent();r.label=4;case 4:return[2,Promise.reject(t)];case 5:return[2]}}))}))};e.prototype.addDecorator=function(t){this._hooks.decorators.push(t)};e.prototype.addOverride=function(t){this._hooks.overrides.push(t)};e.prototype.demo=function(){var t=this._createSpanFromError(new Error("Hello world! This is an error used for demonstration purposes."));t.setAction("TestAction").setParams({path:"/hello",method:"GET"}).setTags({demo_sample:"true"});this.send(t)};e.prototype.addBreadcrumb=function(t){var r=n(n({timestamp:Math.round((new Date).getTime()/1e3)},t),{metadata:h(t.metadata)});if(r.category)if(r.action){this._breadcrumbs.length===20&&this._breadcrumbs.pop();this._breadcrumbs.unshift(r)}else console.warn("[APPSIGNAL]: Breadcrumb not added. `action` is missing.");else console.warn("[APPSIGNAL]: Breadcrumb not added. `category` is missing.")};e.prototype._createSpanFromError=function(t){var r=this.createSpan();r.setError(t);return r};return e}();function T(t){return new RegExp(t.source,t.flags.replace("g",""))}export{P as Span,N as default,s as isError};

